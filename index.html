<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ortasks</title>
</head>
<style>

*{
    margin: 0;
    padding: 0;
}

#add-tasks{
    display: grid;
}
#add-tasks-buttons{
    display: grid;
    grid-template-columns: 1fr 1fr;
}

#sort-tasks-by-value{
    display: none;
}

#sort-tasks-by-effort{
    display: none;
}

#decide-weights{
    display: none;
}

#decide-weights-range{
    display: grid;
    grid-template-columns: 1fr 2fr 1fr;
    text-align: center;
}

.add-tasks-list-item{
    display: grid;
    grid-template-columns: 4fr 1fr;
}

</style>
<body>

<div id="add-tasks" class="screen">
    <h1>Add Tasks</h1>
    <input id="task-description" type="text" value="Next task">
    <div id="add-tasks-buttons"><button id="next-task">Add task</button><button id="finished-adding-task">Sort tasks</button></div>
    <div id="add-tasks-list">
    </div>
</div>

<div id="sort-tasks-by-value" class="screen">
    <h1>Which task is more valuable?</h1>
    <p><a id="task-a-value" href="#">Task A</a></p>
    <p><a id="task-b-value" href="#">Task B</a></p>
</div>

<div id="sort-tasks-by-effort" class="screen">
    <h1>Which task takes more effort?</h1>
    <p><a id="task-a-effort" href="#">Task A</a></p>
    <p><a id="task-b-effort" href="#">Task B</a></p>
</div>

<div id="decide-weights" class="screen">
    <h1>What do you prefer?</h1>
    <div id="decide-weights-range">
    More Value
    <input type="range" id="weights" name="weights" min="0" max="10">
    LessEffort
    </div>
    <button id="show-results">Show results!</button>
</div>

<div id="results" class="screen">
    <div id="ordered-tasks-list">
    </div>
</div>

<script>

//order valueWeigthOrder * value + effortValueOrder * effort

const show = (screenId) => {
    for(s of Array.from(document.getElementsByClassName("screen"))){
        s.style.display = "none"
    }
    document.getElementById(screenId).style.display = "grid"
}

const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)]

let tasks = []
let tasksOrderedByValue = []//0 is more valuable
let tasksOrderedByEffort = []//0 is less effort

let valueWeigth = 1
let effortWeigth = 1

let contexts = []

var currentContext

const reRenderTasks = () => {
    const taskList = document.getElementById("add-tasks-list")
    taskList.innerHTML = ''
    for(task of tasks){
        const div = document.createElement("div")
        div.classList.add("add-tasks-list-item")
        const span = document.createElement("span")
        span.textContent = task.description
        div.appendChild(span)
        const button = document.createElement("button")
        button.textContent = "Delete"
        let description = task.description
        button.addEventListener("click", ()=>{
           tasks = tasks.filter(t => t.description != description)
           reRenderTasks()
        })
        div.appendChild(button)
        taskList.appendChild(div)
    }
}

const compareByValue = (taskA, taskB) => {
    document.getElementById("task-a-value").textContent = tasksOrderedByValue[taskA].description
    document.getElementById("task-b-value").textContent = tasksOrderedByValue[taskB].description
    show("sort-tasks-by-value")
}

const compareByEffort = (taskA, taskB) => {
    document.getElementById("task-a-effort").textContent = tasksOrderedByEffort[taskA].description
    document.getElementById("task-b-effort").textContent = tasksOrderedByEffort[taskB].description
    show("sort-tasks-by-effort")
}

const nextStep = () => {
    if(contexts.length == 0){
        console.log("DONE")
        console.log(tasksOrderedByValue)
        console.log(tasksOrderedByEffort)
        show("decide-weights")
        return
    }
    currentContext = getRandomItem(contexts)
    let notYetComparedToPivotIndex = currentContext.notYetComparedToPivotIndex
    let end = currentContext.end
    let firstBiggerThanPivot = currentContext.firstBiggerThanPivot
    let tasksOrdered
    let compare
    if(currentContext.sorting == "value"){
        tasksOrdered = tasksOrderedByValue
        compare = compareByValue
    }else{
        tasksOrdered = tasksOrderedByEffort
        compare = compareByEffort
    }

    if(notYetComparedToPivotIndex < end){
        compare(notYetComparedToPivotIndex, end)
    }else{
        let tmp = tasksOrdered[end]
        tasksOrdered[end] = tasksOrdered[firstBiggerThanPivot]
        tasksOrdered[firstBiggerThanPivot] = tmp

        let contextSolved = currentContext
        contexts = contexts.filter(c => c != currentContext)
        if(contextSolved.end - contextSolved.start == 1){
            if(tasksOrdered[contextSolved.end] < tasksOrdered[contextSolved.start]){
                let tmp = tasksOrdered[contextSolved.end]
                tasksOrdered[contextSolved.end] = tasksOrdered[contextSolved.start]
                tasksOrdered[contextSolved.start] = tmp
            }
            nextStep()
            return
        }
        let newPivot = Math.floor( (contextSolved.start + contextSolved.end) / 2 )
        contexts.push({"sorting": contextSolved.sorting, "start":contextSolved.start, "end":newPivot, "firstBiggerThanPivot": 0, "notYetComparedToPivotIndex": 0})
        contexts.push({"sorting": contextSolved.sorting, "start":newPivot + 1, "end":contextSolved.end, "firstBiggerThanPivot": newPivot, "notYetComparedToPivotIndex": newPivot})
    }
}

const pivotIsSmaller = ()=>{
    currentContext.notYetComparedToPivotIndex += 1
    nextStep()
}

const pivotIsBigger = ()=>{
    let aValueIndex = currentContext.firstBiggerThanPivot
    let notYetComparedToPivotIndex = currentContext.notYetComparedToPivotIndex
    currentContext.notYetComparedToPivotIndex += 1
    if(currentContext.sorting == "value"){
        tasksOrdered = tasksOrderedByValue
    }else{
        tasksOrdered = tasksOrderedByEffort
    }
    let tmp = tasksOrdered[notYetComparedToPivotIndex]
    tasksOrdered[notYetComparedToPivotIndex] = tasksOrdered[aValueIndex]
    tasksOrdered[aValueIndex] = tmp
    currentContext.firstBiggerThanPivot+= 1
    nextStep()
}

document.getElementById("task-a-value").addEventListener("click", pivotIsSmaller)
document.getElementById("task-a-effort").addEventListener("click", pivotIsSmaller)
document.getElementById("task-b-value").addEventListener("click", pivotIsBigger)
document.getElementById("task-b-effort").addEventListener("click", pivotIsBigger)

const addTask = () => {
    const taskDescription = document.getElementById("task-description")
    const value = taskDescription.value
    taskDescription.value = ""
    tasks.push({
        "description": value,
        "effort": 0,
        "value": 0,
        "random": Math.random()
    })
    reRenderTasks()
}

document.getElementById("next-task").addEventListener("click", addTask)

document.getElementById("task-description").addEventListener("keyup", (event) => {
  if (event.keyCode === 13) {
    event.preventDefault();
    document.getElementById("next-task").click();
  }
});

document.getElementById("finished-adding-task").addEventListener("click", ()=>{
    tasks.sort((a, b) => a.random - b.random)
    tasksOrderedByValue = [...tasks]
    tasksOrderedByEffort = [...tasks]
    console.log(tasks)
    contexts = [
        {"sorting":"value", "start":0, "end":tasks.length -1, "firstBiggerThanPivot": 0, "notYetComparedToPivotIndex": 0},
        {"sorting":"effort", "start":0, "end":tasks.length -1, "firstBiggerThanPivot": 0, "notYetComparedToPivotIndex": 0}
    ]
    nextStep()
})


document.getElementById("show-results").addEventListener("click", ()=>{
    for(let i = 0; i < tasksOrderedByValue.length; i++){
        tasksOrderedByValue[i].value = i
    }
    for(let i = 0; i < tasksOrderedByValue.length; i++){
        tasksOrderedByEffort[i].effort = (tasksOrderedByEffort.length -1) - i
    }
    const valueWeigth = 1
    const effortWeigth = 1

    tasks.sort((a, b) => (b.value * valueWeigth + b.effort * effortWeigth) - (a.value * valueWeigth + a.effort * effortWeigth))
    
    const taskList = document.getElementById("ordered-tasks-list")
    taskList.innerHTML = ''
    for(task of tasks){
        const div = document.createElement("div")
        const span = document.createElement("span")
        span.textContent = task.description
        div.appendChild(span)
        let description = task.description
        taskList.appendChild(div)
    }
    console.log(tasks)
    show("results")
})

</script>

</body>
</html>